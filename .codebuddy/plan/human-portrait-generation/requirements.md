# 需求文档

## 引言

本文档描述将现有的宠物写真生成功能改造为**真人写真生成**功能的需求。新功能将支持用户上传两张图片：一张是待生成写真的人物照片（主体图），另一张是风格参考图。系统将基于风格参考图的风格，对人物照片进行写真风格化处理，生成高质量的真人写真照片。

## 需求

### 需求 1：后端 API 支持双图片输入

**用户故事：** 作为一名开发者，我希望后端 API 能接收两张图片（人物照片和风格参考图），以便系统能够根据风格参考图对人物照片进行写真生成。

#### 验收标准

1. WHEN 前端发送包含两张图片的请求 THEN 系统 SHALL 正确接收并解析两张图片（主体图和风格参考图）
2. WHEN 任一图片缺失 THEN 系统 SHALL 返回明确的错误提示，说明缺少哪张图片
3. WHEN 图片格式不支持（非 jpg/png/webp） THEN 系统 SHALL 返回格式错误提示
4. WHEN 图片大小超过限制（如单张超过 10MB） THEN 系统 SHALL 返回文件大小超限的错误提示

### 需求 2：Prompt 适配真人写真场景

**用户故事：** 作为一名用户，我希望生成的写真照片是针对真人的专业写真风格，而不是宠物风格，以便获得符合预期的人物写真效果。

#### 验收标准

1. WHEN 系统处理人物照片 THEN 系统 SHALL 使用适合真人写真的 prompt，包含人像摄影、美肤、光影等相关描述
2. WHEN 存在风格参考图 THEN 系统 SHALL 在 prompt 或 API 参数中融入风格参考的要素
3. WHEN 生成写真 THEN 系统 SHALL 保持人物面部特征的辨识度，确保生成结果仍能识别为同一人

### 需求 3：API 参数调整

**用户故事：** 作为一名开发者，我希望调用的图像生成 API 参数能够适配风格迁移场景，以便充分利用风格参考图来影响最终生成效果。

#### 验收标准

1. WHEN 调用字节 API THEN 系统 SHALL 传递主体图和风格参考图的 base64 数据
2. IF 字节 API 支持图生图+风格参考模式 THEN 系统 SHALL 使用对应的 req_key 和参数结构
3. IF 字节 API 不支持双图输入 THEN 系统 SHALL 采用替代方案（如将风格特征融入 prompt 描述）
4. WHEN 设置重绘强度 THEN 系统 SHALL 使用适合保留人物特征的参数值（建议 0.4-0.6）

### 需求 4：前端双图片上传界面

**用户故事：** 作为一名用户，我希望前端界面提供两个独立的图片上传区域，以便我能够分别上传人物照片和风格参考图。

#### 验收标准

1. WHEN 用户访问上传页面 THEN 系统 SHALL 显示两个明确区分的上传区域，分别标注"上传人物照片"和"上传风格参考图"
2. WHEN 用户上传图片 THEN 系统 SHALL 显示图片预览
3. WHEN 任一上传区域为空时点击生成 THEN 系统 SHALL 提示用户需要上传两张图片
4. WHEN 用户想要更换已上传图片 THEN 系统 SHALL 提供重新上传或删除的功能

### 需求 5：前端表单提交适配

**用户故事：** 作为一名开发者，我希望前端能够正确构造包含两张图片的请求，以便与后端 API 正确对接。

#### 验收标准

1. WHEN 用户点击生成按钮 THEN 前端 SHALL 将两张图片以 FormData 形式发送到后端
2. WHEN 发送请求 THEN 前端 SHALL 使用正确的字段名区分主体图（如 `main_file`）和风格参考图（如 `style_file`）
3. WHEN 请求过程中 THEN 前端 SHALL 显示加载状态，禁用提交按钮
4. WHEN 后端返回错误 THEN 前端 SHALL 显示友好的错误提示信息

### 需求 6：生成结果展示

**用户故事：** 作为一名用户，我希望生成完成后能够查看和下载写真结果，以便保存满意的照片。

#### 验收标准

1. WHEN 后端返回生成结果 THEN 前端 SHALL 清晰展示生成的写真图片
2. WHEN 用户想要保存图片 THEN 前端 SHALL 提供下载按钮支持一键下载
3. WHEN 用户想要重新生成 THEN 前端 SHALL 提供重新生成按钮，可使用相同输入再次生成

## 技术考量

### 边界情况处理

1. **大尺寸图片**：需要在后端或前端进行图片压缩，避免超过 API 限制
2. **人脸检测**：可考虑增加人脸检测校验，确保上传的是人物照片
3. **生成超时**：设置合理的超时时间和重试机制

### 用户体验建议

1. 提供示例图片，帮助用户理解什么是风格参考图
2. 生成过程中显示预估时间或进度提示
3. 支持查看最近生成的历史记录

### 技术限制

1. 依赖字节火山引擎 API 的能力，需要确认 API 是否支持风格参考图的传入
2. 生成时间可能较长（10-30秒），需要做好前端等待体验

## 成功标准

1. 用户能够成功上传两张图片并生成写真
2. 生成的写真能够保留人物面部特征的辨识度
3. 生成的写真风格与参考图风格相近
4. 整个流程响应时间不超过 60 秒
5. 错误情况有明确的提示信息
